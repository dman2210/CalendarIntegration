<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="glass.css">
    <link rel="stylesheet" href="glassCal.css">
    <link rel="stylesheet" href="index.css">
    <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>

</head>

<body>
    <div style="display:flex;align-items: center;justify-content: center;">
        <h1>
            Book Appointment
        </h1>
    </div>
    <div id="background">
        <div id="squareContainer" style="display:none">
            <form id="payment-form">
                <div id="card-container"></div>
                <button id="card-button" type="button">Pay $1.00</button>
            </form>
            <div id="payment-status-container"></div>
        </div>
        <script type="text/javascript">
        var paymentURL = 'https://calendar-integration-backend.vercel.app/api/payments';
            const appId = 'sandbox-sq0idb-k47NFyfiTnNf1wkfFcHAvg';
            const locationId = 'LXSNHMQ7X5J6G';
    
            async function initializeCard(payments) {
                const card = await payments.card();
                await card.attach('#card-container');
                console.log("thing attached");
                return card;
            }
    
            async function createPayment(token) {
                const body = JSON.stringify({
                    amount: 100,
                    source: token,
                });
    
                const paymentResponse = await fetch(paymentURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body,
                });
    
                if (paymentResponse.ok) {
                    return "Yay!!";
                }else{
                    return paymentResponse;
                }
    
                const errorBody = await paymentResponse.text();
                throw new Error(errorBody);
            }
    
            async function tokenize(paymentMethod) {
                const tokenResult = await paymentMethod.tokenize();
                console.log(tokenResult);
                if (tokenResult.status === 'OK') {
                    return tokenResult.token;
                } else {
                    let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
                    if (tokenResult.errors) {
                        errorMessage += ` and errors: ${JSON.stringify(
                            tokenResult.errors
                        )}`;
                    }
    
                    throw new Error(errorMessage);
                }
            }
    
            // status is either SUCCESS or FAILURE;
            function displayPaymentResults(status) {
                const statusContainer = document.getElementById(
                    'payment-status-container'
                );
                if (status === 'SUCCESS') {
                    statusContainer.classList.remove('is-failure');
                    statusContainer.classList.add('is-success');
                } else {
                    statusContainer.classList.remove('is-success');
                    statusContainer.classList.add('is-failure');
                }
    
                statusContainer.style.visibility = 'visible';
            }
            
                document.addEventListener('DOMContentLoaded', runSquare());
    
            async function runSquare() {
                if (!window.Square) {
                    throw new Error('Square.js failed to load properly');
                }
    
                let payments;
                try {
                    payments = window.Square.payments(appId, locationId);
                } catch {
                    const statusContainer = document.getElementById(
                        'payment-status-container'
                    );
                    statusContainer.className = 'missing-credentials';
                    statusContainer.style.visibility = 'visible';
                    return;
                }
    
                let card;
                try {
                    card = await initializeCard(payments);
                } catch (e) {
                    console.error('Initializing Card failed', e);
                    return;
                }
    
                // Checkpoint 2.
                async function handlePaymentMethodSubmission(event, paymentMethod) {
                    event.preventDefault();
    
                    try {
                        // disable the submit button as we await tokenization and make a payment request.
                        cardButton.disabled = true;
                        const token = await tokenize(paymentMethod);
                        console.log("sending request...");
                        const paymentResults = await createPayment(token);
                        console.log("request success");
                        displayPaymentResults('SUCCESS');
                        let main = document.getElementById("main");
                        main.innerHTML = `<h1>Payment success!! Receipt has been emailed with scheduling info.</h1>`;
                        console.debug('Payment Success', paymentResults);
                    } catch (e) {
                        cardButton.disabled = false;
                        displayPaymentResults('FAILURE');
                        console.error(e.message);
                    }
                }
    
                const cardButton = document.getElementById('card-button');
                cardButton.addEventListener('click', async function (event) {
                    await handlePaymentMethodSubmission(event, card);
                });
            };
        </script>
        <div id="main" style="display:flex;justify-content: center;flex-direction: column;">
            <div id="calendar" style="display:none; width:unset"></div>
            <div id="label" class="label">
                <h3 style="text-align: center;">
                    How often?
                </h3>
            </div>
            <div style="display:flex;justify-content: center;">
                <div style="display:flex;align-items: center;justify-content: center;flex-direction: column;">

                    <div id="buttons" style="display:flex; flex-direction: column;">
                        <script>
                            function checkDates(frequencyChoice) {
                                //implement conflict checking
                                document.getElementById("calendar").style.display = "flex";
                                // document.getElementById("label").style.position = "unset";
                                document.getElementById("main").style.flexDirection = "unset";
                                let buttons = document.getElementById("buttons").children;
                                Array.from(buttons).forEach((button) => {
                                    if (button.id !== frequencyChoice) {
                                        button.style.display = "none";
                                    }
                                });
                                document.getElementById("label").innerText = "What Day?"
                            }
                            let cleaningOptions = [
                                {
                                    frequency: "One Cleaning",
                                    price: 175,
                                    note: "2 Hours",
                                    short: "one",

                                },
                                {
                                    frequency: "Monthly",
                                    price: 175,
                                    note: "2 Hours",
                                    short: "monthly",
                                },
                                {
                                    frequency: "Weekly",
                                    price: 175,
                                    note: "2 Hours",
                                    short: "weekly"
                                },
                                {
                                    frequency: "Bi-Weekly",
                                    price: 175,
                                    note: "2 Hours",
                                    short: "biweekly"
                                }
                            ]
                            let buttons = cleaningOptions.map((option) => {
                                return (
                                    `<button class="buttonAdapt" id="${option.short}" onClick=checkDates("${option.short}")>
                                    <div>
                                    <div style="display:flex;align-items: flex-start; flex-direction:column;margin-right:10vw; padding:5px">
                                        <div class="buttonItem">
                                            <h4 style="display:flex">
                                                ${option.frequency} - ${option.note}
                                            </h4>
                                        </div>
                                        <div class="buttonItem">
                                            <p>
                                                $${option.price.toString()}.00
                                            </p>
                                        </div>
                                    </div>
                                    </div>
                                </button>`)
                            })
                            document.getElementById("buttons").innerHTML = buttons;
                        </script>
                    </div>
                    <div id="hoursWrapper" style="display:none">
                        <button id="hours" class="buttonAdapt">

                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script type='text/javascript' src='./calendar.js'></script>
    <script>
        dycalendar.draw({
            target: '#calendar',
            type: 'month',
            dayformat: 'full',
            monthformat: 'full',
            highlighttargetdate: true,
            prevnextbutton: 'show'

        })
    </script>
</body>

</html>